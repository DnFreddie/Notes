<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="noindex, nofollow"><title>Postgres | ExampleSite</title>
<meta name=keywords content><meta name=description content='--- date:: 16 04 2023 type:: Data alaises:: Postgconn Baisic Checking health [!bug] Pinging From time to time the Postgres container will not be ready to accept connections when we try to run sqlx database create.
To solve this we need to ping it to see if its healthy
# Keep pinging Postgres until it&#39;s ready to accept commands export PGPASSWORD="${DB_PASSWORD}" until psql -h "localhost" -U "${DB_USER}" -p "${DB_PORT}" -d "postgres" -c &#39;\q&#39;; do >&amp;2 echo "Postgres is still unavailable - sleeping" sleep 1 done >&amp;2 echo "Postgres is up and running on port ${DB_PORT}!'><meta name=author content="Me"><link rel=canonical href=http://localhost:1313/posts/metasploit_framework/postgres/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/metasploit_framework/postgres/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Postgres</h1><div class=post-meta><span title='2024-07-22 09:10:24 +0200 CEST'>July 22, 2024</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;318 words&nbsp;·&nbsp;Me</div></header><div class=post-content><pre><code>---
</code></pre><h2 id=alaises-postgconn>date:: 16 04 2023
type:: Data
alaises:: Postgconn</h2><h2 id=baisic>Baisic<a hidden class=anchor aria-hidden=true href=#baisic>#</a></h2><h3 id=checking-health>Checking health<a hidden class=anchor aria-hidden=true href=#checking-health>#</a></h3><blockquote><p>[!bug] Pinging
From time to time the Postgres container will not be ready to accept connections when we try to run sqlx database create.</p></blockquote><p>To solve this we need to ping it to see if its <em>healthy</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Keep pinging Postgres until it&#39;s ready to accept commands</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PGPASSWORD</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DB_PASSWORD</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>until</span> psql -h <span class=s2>&#34;localhost&#34;</span> -U <span class=s2>&#34;</span><span class=si>${</span><span class=nv>DB_USER</span><span class=si>}</span><span class=s2>&#34;</span> -p <span class=s2>&#34;</span><span class=si>${</span><span class=nv>DB_PORT</span><span class=si>}</span><span class=s2>&#34;</span> -d <span class=s2>&#34;postgres&#34;</span> -c <span class=s1>&#39;\q&#39;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>&gt;<span class=p>&amp;</span><span class=m>2</span> <span class=nb>echo</span> <span class=s2>&#34;Postgres is still unavailable - sleeping&#34;</span>
</span></span><span class=line><span class=cl>sleep <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>&gt;<span class=p>&amp;</span><span class=m>2</span> <span class=nb>echo</span> <span class=s2>&#34;Postgres is up and running on port </span><span class=si>${</span><span class=nv>DB_PORT</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>DATABASE_URL</span><span class=o>=</span>postgres://<span class=si>${</span><span class=nv>DB_USER</span><span class=si>}</span>:<span class=si>${</span><span class=nv>DB_PASSWORD</span><span class=si>}</span>@localhost:<span class=si>${</span><span class=nv>DB_PORT</span><span class=si>}</span>/<span class=si>${</span><span class=nv>DB_NAME</span><span class=si>}</span>
</span></span><span class=line><span class=cl>sqlx database create
</span></span></code></pre></div><p>$$1$$</p><h2 id=establisch-docker-connection>Establisch docker connection<a hidden class=anchor aria-hidden=true href=#establisch-docker-connection>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>set</span> -x
</span></span><span class=line><span class=cl><span class=nb>set</span> -eo pipefail
</span></span><span class=line><span class=cl><span class=k>if</span> ! <span class=o>[</span> -x <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>command</span> -v psql<span class=k>)</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> &gt;<span class=p>&amp;</span><span class=m>2</span> <span class=s2>&#34;Error: psql is not installed.&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>if</span> ! <span class=o>[</span> -x <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>command</span> -v sqlx<span class=k>)</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> &gt;<span class=p>&amp;</span><span class=m>2</span> <span class=s2>&#34;Error: sqlx is not installed.&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> &gt;<span class=p>&amp;</span><span class=m>2</span> <span class=s2>&#34;Use:&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> &gt;<span class=p>&amp;</span><span class=m>2</span> <span class=s2>&#34; cargo install --version=0.5.7 sqlx-cli --no-default-features --features postgres&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> &gt;<span class=p>&amp;</span><span class=m>2</span> <span class=s2>&#34;to install it.&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=c1># Check if a custom user has been set, otherwise default to &#39;postgres&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>DB_USER</span><span class=o>=</span><span class=si>${</span><span class=nv>POSTGRES_USER</span><span class=p>:=postgres</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=c1># Check if a custom password has been set, otherwise default to &#39;password&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>DB_PASSWORD</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>POSTGRES_PASSWORD</span><span class=p>:=password</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Check if a custom database name has been set, otherwise default to &#39;newsletter&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>DB_NAME</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>POSTGRES_DB</span><span class=p>:=newsletter</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Check if a custom port has been set, otherwise default to &#39;5432&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>DB_PORT</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>POSTGRES_PORT</span><span class=p>:=5432</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Launch postgres using Docker</span>
</span></span><span class=line><span class=cl>docker run <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-e <span class=nv>POSTGRES_USER</span><span class=o>=</span><span class=si>${</span><span class=nv>DB_USER</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-e <span class=nv>POSTGRES_PASSWORD</span><span class=o>=</span><span class=si>${</span><span class=nv>DB_PASSWORD</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-e <span class=nv>POSTGRES_DB</span><span class=o>=</span><span class=si>${</span><span class=nv>DB_NAME</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-p <span class=s2>&#34;</span><span class=si>${</span><span class=nv>DB_PORT</span><span class=si>}</span><span class=s2>&#34;</span>:5432 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-d postgres <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>postgres -N <span class=m>1000</span>
</span></span><span class=line><span class=cl><span class=c1># ^ Increased maximum number of connections for testing purposes</span>
</span></span><span class=line><span class=cl><span class=c1># Keep pinging Postgres until it&#39;s ready to accept commands</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PGPASSWORD</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>DB_PASSWORD</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>until</span> psql -h <span class=s2>&#34;localhost&#34;</span> -U <span class=s2>&#34;</span><span class=si>${</span><span class=nv>DB_USER</span><span class=si>}</span><span class=s2>&#34;</span> -p <span class=s2>&#34;</span><span class=si>${</span><span class=nv>DB_PORT</span><span class=si>}</span><span class=s2>&#34;</span> -d <span class=s2>&#34;postgres&#34;</span> -c <span class=s1>&#39;\q&#39;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>&gt;<span class=p>&amp;</span><span class=m>2</span> <span class=nb>echo</span> <span class=s2>&#34;Postgres is still unavailable - sleeping&#34;</span>
</span></span><span class=line><span class=cl>sleep <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>&gt;<span class=p>&amp;</span><span class=m>2</span> <span class=nb>echo</span> <span class=s2>&#34;Postgres is up and running on port </span><span class=si>${</span><span class=nv>DB_PORT</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>DATABASE_URL</span><span class=o>=</span>postgres://<span class=si>${</span><span class=nv>DB_USER</span><span class=si>}</span>:<span class=si>${</span><span class=nv>DB_PASSWORD</span><span class=si>}</span>@localhost:<span class=si>${</span><span class=nv>DB_PORT</span><span class=si>}</span>/<span class=si>${</span><span class=nv>DB_NAME</span><span class=si>}</span>
</span></span><span class=line><span class=cl>sqlx database create
</span></span></code></pre></div><blockquote><p>[!quote] <a href=/libriairies/Tokio_rs.md>Tokio_rs</a> [Databaes Types](/databases/Databaes Types.md) [[SQL REVISE#SQL]]</p></blockquote></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/postcard/><span class=title>« Prev</span><br><span>Postcard</span>
</a><a class=next href=http://localhost:1313/posts/pow_algorithms/><span class=title>Next »</span><br><span>PoW_algorithms</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>ExampleSite</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>